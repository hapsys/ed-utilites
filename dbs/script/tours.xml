<?xml version="1.0" encoding="UTF-8"?>
<include>
    <table name="tournament">
		<select name="ByPrimaryKey" single_object="true">
			<column name="tournament_id"/>
		</select>
		<query name="TournamentInfo">
			<sql>
			    SELECT 1 as tournament, 1 as ship_classes, 1 as ship_classes_users, 1 as user_roles,
			    1 as tournament_users_roles, 1 as calendar, 1 as calendar_remove, 1 as button_state, 1 as user_current
		    </sql>
		</query>
        <query name="PastTournamentCount" single_object="true">
            <column name="Now"/>
            <sql>
                SELECT COUNT(tournament_id) as count
                FROM tournament
                WHERE start_date &lt;= ?
                AND is_finished = 1
                LIMIT 1
            </sql>
        </query>
        <query name="CurrentTournamentCount" single_object="true">
            <column name="Now"/>
            <sql>
                SELECT COUNT(tournament_id) as count
                FROM tournament
                WHERE start_date &lt;= ?
                AND is_finished = 0
                LIMIT 1
            </sql>
        </query>
        <query name="ComingTournamentCount" single_object="true">
            <column name="Now"/>
            <sql>
                SELECT COUNT(tournament_id) as count
                FROM tournament
                WHERE start_date &gt; ?
                AND is_finished = 0
                LIMIT 1
            </sql>
        </query>
        <query name="TournamentList" intruder="\ed\tournaments\filter\TournamentFilter">
            <sql>
                SELECT t.*, DATE(t.start_date) as start_date, UNIX_TIMESTAMP(t.start_date) as start_date_timestamp,
                count(DISTINCT urb.tournament_user_id) as battler_count,
                count(DISTINCT urr.tournament_user_id) as referee_count,
                count(DISTINCT uro.tournament_user_id) as operator_count,
                GROUP_CONCAT(DISTINCT c.ship_class_id ORDER BY c.sort SEPARATOR ',') as ship_classes
                FROM tournament t
                LEFT JOIN tournament_users tu ON tu.tournament_id = t.tournament_id
                LEFT JOIN tournament_user_roles urb ON urb.tournament_user_id = tu.tournament_user_id AND urb.role_id = (SELECT rb.role_id FROM roles rb WHERE rb.role = 'ROLE_BATTLER' LIMIT 1)
                LEFT JOIN tournament_user_roles urr ON urr.tournament_user_id = tu.tournament_user_id AND urr.role_id = (SELECT rr.role_id FROM roles rr WHERE rr.role = 'ROLE_REFEREE' LIMIT 1)
                LEFT JOIN tournament_user_roles uro ON urr.tournament_user_id = tu.tournament_user_id AND uro.role_id = (SELECT ro.role_id FROM roles ro WHERE ro.role = 'ROLE_OPERATOR' LIMIT 1)
                LEFT JOIN tournament_ship_classes sc ON sc.tournament_id = t.tournament_id
                LEFT JOIN ship_classes c ON c.ship_class_id = sc.ship_class_id
                WHERE 1=1
                <where/>
                GROUP BY t.tournament_id
                ORDER BY t.start_date DESC
            </sql>
        </query>
    </table>
    <table name="tournament_users">
		<select name="ByForeignKeys" single_object="true">
			<column name="tournament_id"/>
			<column name="user_id"/>
		</select>
        <delete name="ByPrimaryKey">
			<column name="tournament_user_id"/>
        </delete>
		<query name="TournamentUserShipClasses">
            <column name="TournamentId"/>
            <sql>
                SELECT u.*, c.ship_class_id
                FROM users u, tournament_users tu
                LEFT JOIN tournament_user_ship_classes sc ON sc.tournament_user_id = tu.tournament_user_id
                LEFT JOIN ship_classes c ON c.ship_class_id = sc.ship_class_id
                WHERE tu.tournament_id = ?
                AND tu.user_id = u.user_id
                ORDER BY c.sort, u.cmdr_name
        	</sql>
        </query>
	</table>
    <table name="tournament_ship_classes">
        <query name="TournamentShipClassesByTournamentId">
        	<column name="TournamentId"/>
            <sql>
                SELECT c.ship_class_id
                FROM tournament_ship_classes sc, ship_classes c
                WHERE sc.tournament_id = ?
                AND c.ship_class_id = sc.ship_class_id
                ORDER BY c.sort
        	</sql>
        </query>
        <query name="TournamentShipClassesForUser">
            <column name="UserId"/>
            <column name="TournamentId"/>
            <sql>
                SELECT c.ship_class_id, sc.ship_class_id as using_class
                FROM ship_classes c, tournament_ship_classes tsc
                LEFT JOIN tournament_users tu ON tu.tournament_id = tsc.tournament_id AND tu.user_id = ?
                LEFT JOIN tournament_user_ship_classes sc ON sc.tournament_user_id = tu.tournament_user_id AND sc.ship_class_id = tsc.ship_class_id
                WHERE tsc.tournament_id = ?
                AND tsc.ship_class_id=c.ship_class_id
                ORDER BY c.sort
        	</sql>
        </query>
        <query name="TournamentShipClassesUsers">
        	<column name="TournamentId"/>
            <sql>
                SELECT c.ship_class_id, u.user_id, u.email, u.cmdr_name
                FROM ship_classes c, tournament_user_ship_classes usc, tournament_users tu, users u
                WHERE tu.tournament_id = ?
                AND tu.tournament_user_id = usc.tournament_user_id
                AND u.user_id = tu.user_id
                AND c.ship_class_id = usc.ship_class_id
                ORDER BY c.sort, u.cmdr_name
        	</sql>
        </query>
        <!--
        <query name="TournamentShipClassesUsers">
        	<column name="TournamentId"/>
            <sql>
                SELECT c.ship_class_id, u.user_id, u.email, u.cmdr_name
                FROM (tournament_ship_classes sc, ship_classes c)
                LEFT JOIN tournament_user_ship_classes usc ON usc.ship_class_id = sc.ship_class_id
                LEFT JOIN tournament_users tu ON tu.tournament_user_id = usc.tournament_user_id
                LEFT JOIN users u ON u.user_id = tu.user_id
                WHERE sc.tournament_id = ?
                AND c.ship_class_id = sc.ship_class_id
                ORDER BY c.sort, u.cmdr_name
        	</sql>
        </query>
		 -->
    </table>
    <table name="tournament_user_roles">
        <delete name="ByForeignKeys">
			<column name="tournament_user_id"/>
			<column name="role_id"/>
        </delete>
        <delete name="ByTournamentUserId">
			<column name="tournament_user_id"/>
        </delete>
        <query name="TournamentRolesForUser">
            <column name="TournamentId"/>
            <column name="UserId"/>
            <sql>
                SELECT r.*, tur.tournament_user_id as using_role
                FROM roles r
                LEFT JOIN tournament_user_roles tur ON tur.role_id = r.role_id AND tur.tournament_user_id =
                	(
                	SELECT tu.tournament_user_id
                	FROM tournament_users tu
                	WHERE tu.tournament_id = ?
                	AND tu.user_id = ?
                	LIMIT 1
                	)
                WHERE 1 = 1
                ORDER BY r.role_id
        	</sql>
        </query>
        <query name="TournamentUsersRoles">
            <column name="TournamentId"/>
            <sql>
                SELECT r.*, u.user_id, u.email, u.cmdr_name
                FROM tournament_users tu, tournament_user_roles tur, roles r, users u
                WHERE  tu.tournament_id = ?
                AND tur.tournament_user_id = tu.tournament_user_id
                AND u.user_id = tu.user_id
                AND r.role_id = tur.role_id
                ORDER BY r.role_id, u.cmdr_name
            </sql>
        </query>
    </table>
	<table name="tournament_user_ship_classes">
        <delete name="ByForeignKeys">
			<column name="tournament_user_id"/>
			<column name="ship_class_id"/>
        </delete>
        <delete name="ByTournamentUserId">
			<column name="tournament_user_id"/>
        </delete>
    </table>
	<table name="user_calendar">
        <update name="ByPrimaryKeyAndTournamentUserId">
			<column name="user_calendar_id"/>
			<column name="tournament_user_id"/>
        </update>
	    <delete name="ByPrimaryKeyAndTournamentUserId">
			<column name="user_calendar_id"/>
			<column name="tournament_user_id"/>
        </delete>
	    <delete name="ByTournamentUserId">
			<column name="tournament_user_id"/>
        </delete>
        <query name="CalendarForUser">
            <column name="TournamentId"/>
            <column name="UserId"/>
            <sql>
                SELECT c.user_calendar_id, HOUR(c.start_time) AS start_time_hour, MINUTE(c.start_time) AS start_time_minutes,
                HOUR(c.end_time) AS end_time_hour, MINUTE(c.end_time) AS end_time_minutes,
                c.day_of_week &amp; 1 as day_of_week_mon,
                c.day_of_week &amp; 2 as day_of_week_tue,
                c.day_of_week &amp; 4 as day_of_week_wed,
                c.day_of_week &amp; 8 as day_of_week_thu,
                c.day_of_week &amp; 16 as day_of_week_fri,
                c.day_of_week &amp; 32 as day_of_week_sat,
                c.day_of_week &amp; 64 as day_of_week_sun
                FROM tournament_users tu, user_calendar c
                WHERE tu.tournament_id = ?
                AND tu.user_id = ?
                AND c.tournament_user_id = tu.tournament_user_id
                ORDER BY c.day_of_week DESC
            </sql>
        </query>

	</table>

</include>